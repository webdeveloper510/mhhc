!function($){"use strict";var self=$.extend({metaboxId:"#gravityview_maps_settings",addressFieldSelector:"#gv_maps_se_map_address_field",formIdSelector:"#gravityview_form_id",addIconSelector:"#gv_maps_se_add_icon",selectIconSelector:"#gv_maps_se_select_icon",inputIconSelector:"#gv_maps_se_map_marker_icon",availableIconsSelector:"#gv_maps_se_available_icons",setIconSelector:".gv_maps_icons",pageSizeField:"#gravityview_se_page_size"},GV_MAPS_ADMIN);self.init=function(){self.isGravityViewScreen&&(self.bindToFormChange(),self.bindMapIcons(),self.bindInfowindowSettings(),self.hideOnDataTables(),self.bindModifyRestOnChangeTemplate(),self.bindGlobalNoticeMapViewsWithoutRest())},self.hideOnDataTables=function(){$(document).on("change","#gravityview_directory_template",function(){$("body").toggleClass("gravityview-template-datatables_table","datatables_table"===$(this).val())})},self.onTemplateChangeModifyRest=event=>{"map"===$(event.target).val()&&self.confirmModifyRest()},self.onLoadCheckForRestValue=()=>{var hasMapField;0===$("#gravityview_se_rest_disable:not(:checked)").length&&(hasMapField=0!==$('.gv-fields[data-fieldid="map"]').filter(":visible").length,"map"===$("#gravityview_directory_template").val()||hasMapField)&&setTimeout(()=>self.confirmModifyRest(self.textModifyRestOnLoadWithMap),500)},self.confirmModifyRest=(text=self.textModifyRestOnMapChanges)=>{self.canModifyRestPermissionsFields()&&window.confirm(text)&&self.modifyRestPermissionFields()},self.canModifyRestPermissionsFields=()=>{var $enable_checkbox=$('[name="template_settings[rest_enable]"]').filter('[type="checkbox"]'),$disable_checkbox=$('[name="template_settings[rest_disable]"]').filter('[type="checkbox"]');return!($enable_checkbox.length&&$enable_checkbox.is(":checked")||$disable_checkbox.length&&$disable_checkbox.not(":checked"))},self.modifyRestPermissionFields=()=>{var $enable_field,$enable_checkbox,$disable_field,$disable_checkbox;self.canModifyRestPermissionsFields()&&($enable_checkbox=($enable_field=$('[name="template_settings[rest_enable]"]')).filter('[type="checkbox"]'),$disable_checkbox=($disable_field=$('[name="template_settings[rest_disable]"]')).filter('[type="checkbox"]'),$enable_field.length&&($enable_field.val(1),$enable_checkbox.prop("checked",!0)),$disable_field.length)&&($disable_field.val(0),$disable_checkbox.prop("checked",!1))},self.onFieldAddedChangeModifyRest=(event,field)=>{$(field).is('[data-fieldid="map"]')&&self.confirmModifyRest()},self.bindModifyRestOnChangeTemplate=()=>{var $body=$("body");$body.one("click","#gv_switch_view_button",()=>{$(document).on("change","#gravityview_directory_template",self.onTemplateChangeModifyRest)}),$body.on("gravityview/field-added",self.onFieldAddedChangeModifyRest)},self.bindToFormChange=function(){$(document).bind("gravityview_form_change",self.updateFields)},self.bindInfowindowSettings=function(){$("#gv_maps_se_map_info_enable").on("change",self.hideInfowindowSettings).change()},self.hideInfowindowSettings=function(){var _this=$(this),otherSettings=$("#gravityview_maps_settings").find("table tr:has(:input[name*=map_info]):gt(0)");_this.is(":checked")?otherSettings.fadeIn():otherSettings.fadeOut(100)},self.updateFields=function(){$(self.addressFieldSelector).prop("disabled",!0).empty().append("<option>"+gvGlobals.loading_text+"</option>");var data={action:"gv_address_fields",formid:$(self.formIdSelector).val(),nonce:self.nonce};$.ajax({type:"POST",url:ajaxurl,data:data,async:!0}).done(function(response){"false"!==response&&"0"!==response&&$(self.addressFieldSelector).empty().append(response).prop("disabled",!1)}).fail(function(jqXHR){console.log("Error while loading the GravityView Map Address Fields. Please try again or contact GravityView support."),console.log(jqXHR)})},self.bindMapIcons=function(){"undefined"!=typeof wp&&wp.media&&wp.media.editor&&$(self.addIconSelector).on("click",self.addMapIcon),self.initMapIconsTooltip(),$("body").on("click",self.setIconSelector,self.setMapIcon)},self.addMapIcon=function(){var mapIconUploader=wp.media({title:self.labelMapIconUploadTitle,button:{text:self.labelMapIconUploadButton},multiple:!1,library:{type:"image"}}).on("select",function(){var attachment=mapIconUploader.state().get("selection").first().toJSON();self.setMapIconInput(attachment.url)}).open()},self.initMapIconsTooltip=function(){$(self.selectIconSelector).tooltip({content:function(){return $(self.availableIconsSelector).html()},close:function(){$(this).attr("data-tooltip",null)},open:function(){$(this).attr("data-tooltip","active")},closeOnEscape:!0,disabled:!0,position:{my:"center bottom",at:"center top-12"},tooltipClass:"top"}).attr("title","").on("mouseout focusout",function(e){e.stopImmediatePropagation()}).click(function(e){$(this).attr("title",""),e.preventDefault(),$(this).tooltip("open")})},self.bindGlobalNoticeMapViewsWithoutRest=()=>{const $triggerButton=$("[data-js='gk-gravitymaps-trigger-update-map-views-rest-api']");if($triggerButton.length){const $container=$triggerButton.parents(".gk-notice").eq(0);$container.is(".is-dismissible");$triggerButton.on("click",event=>{event.preventDefault(),$triggerButton.prop("disabled",!0),$triggerButton.before('<span class="spinner is-active"></span>'),$.ajax({url:ajaxurl,method:"POST",data:{action:"gk_gravitymaps_enable_rest_on_map_views",nonce:$triggerButton.data("gk-ajax-nonce"),single_view_id:$triggerButton.data("gk-single-view-id")},success:response=>{response.success?($container.find("p:has(.button)").remove(),$container.find("p:first").text(response.data.text),setTimeout(()=>$container.fadeOut(),4e3),self.modifyRestPermissionFields()):$container.find("p:first").text(response.data.text)},error:()=>{const $error=$("<p>").text(response.data.text);$container.prepend($error),setTimeout(()=>$error.remove(),4e3)},complete:()=>{$triggerButton.prop("disabled",!1),$triggerButton.siblings(".spinner").remove()}})})}},self.setMapIcon=function(e){e=$(e.target).attr("src");self.setMapIconInput(e),$(self.selectIconSelector).tooltip("close")},self.setMapIconInput=function(url){$(self.inputIconSelector).val(url).prev().attr("src",url)},self.isGravityViewScreen=function(){return"gravityview"===pagenow},$(self.init),$(window).on("load",self.onLoadCheckForRestValue)}(jQuery);