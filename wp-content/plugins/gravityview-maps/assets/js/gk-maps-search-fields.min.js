(($,obj,GravityMaps)=>{"use strict";(GravityMaps.searchFields=obj).className=value=>"string"!=typeof value&&!this instanceof String||"function"!=typeof value.replace?value:value.replace(".",""),obj.selectors={currentLocationButton:".gk-maps-search-current-geolocation",searchBox:".gv-search-box",searchField:".gk-maps-search-geolocation-address-autocomplete",searchFieldCurrentLocation:".gk-maps-search-geolocation-address-autocomplete-current-location",currentLocationButtonActive:".gk-maps-search-current-geolocation-active",currentLocationLng:".gk-maps-search-geolocation-lng",currentLocationLat:".gk-maps-search-geolocation-lat",currentLocationAccuracy:".gk-maps-search-current-geolocation-accuracy",currentLocationFlag:".gk-maps-search-current-geolocation-flag",currentLocationRadius:".gk-maps-search-current-geolocation-radius",currentLocationUnit:".gk-maps-search-current-geolocation-unit",currentLocationHasSearch:".gk-maps-search-current-geolocation-has-search",viewContainer:".gv-container",viewWrapper:'[id^="gv-view-"]',viewWrapperById:id=>`[id^="gv-view-${id}-"]`,viewContainerById:id=>obj.selectors.viewContainer+"-"+id,mapsEntriesContainer:".gv-map-entries",widgetsHeader:".gv-widgets-header",noResults:".gv-no-results",noResultsContainerFlag:".gk-maps-no-results-container-flag"},obj.$currentLocationButton=null,obj.i18n=window.gk_maps_search_fields,obj.onCurrentLocationClick=event=>{event.preventDefault();var $target=$(event.target);$target.is(obj.selectors.currentLocationButton)?obj.$currentLocationButton=$target:obj.$currentLocationButton=$(event.target).parents(obj.selectors.currentLocationButton).eq(0),navigator.geolocation.getCurrentPosition(obj.handleCurrentLocationSuccess,obj.handleCurrentLocationError,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})},obj.resetCurrentLocation=$field=>{$field=$field.parents(obj.selectors.searchBox).eq(0);$field.find(obj.selectors.currentLocationButton).removeClass(obj.className(obj.selectors.currentLocationButtonActive)).prop("title",obj.i18n.currentLocationLabel),$field.find(obj.selectors.currentLocationFlag).val(0)},obj.handleCurrentLocationSuccess=position=>{var position=position.coords,$searchBox=obj.$currentLocationButton.parents(obj.selectors.searchBox),$latField=$searchBox.find(obj.selectors.currentLocationLat),$lngField=$searchBox.find(obj.selectors.currentLocationLng),$accuracyField=$searchBox.find(obj.selectors.currentLocationAccuracy),$currentFlagField=$searchBox.find(obj.selectors.currentLocationFlag),$searchBox=$searchBox.find(obj.selectors.searchField);obj.isValidCoordinates(position)?($latField.val(position.latitude),$lngField.val(position.longitude),$accuracyField.val(position.accuracy),$currentFlagField.val(1),obj.$currentLocationButton.addClass(obj.className(obj.selectors.currentLocationButtonActive)).prop("title",obj.i18n.currentLocationLabel),obj.$currentLocationButton.data("gkCurrentLocationInstantSearch")&&obj.$currentLocationButton.parents("form").eq(0).trigger("submit"),obj.setupCurrentLocationFieldInteractions($searchBox)):window.GV_MAPS.hooks.doAction("gk.maps.invalid_map_coordinates",position)},obj.throwInvalidCoordinatesError=coordinates=>{gvMapsDisplayErrorNotice(obj.i18n.invalidGeolocationCoordinates)},obj.isValidCoordinates=coordinates=>"object"==typeof coordinates&&!(!coordinates.latitude&&!coordinates.longitude),obj.setupCurrentLocationFieldInteractions=$searchField=>{$searchField.each((index,element)=>{const $field=$(element);if($field.siblings(obj.selectors.currentLocationButton).is(obj.selectors.currentLocationButtonActive)){$field.data("currentPlaceholder",$field.attr("placeholder")),$field.attr("placeholder",obj.i18n.currentLocationLabel).addClass(obj.className(obj.selectors.searchFieldCurrentLocation)),$field.val("");const removeContentsCallback=()=>{$field.attr("placeholder",$field.data("currentPlaceholder")).removeClass(obj.className(obj.selectors.searchFieldCurrentLocation)),$field.off("focusout.gkMapsSearchField").one("focusout.gkMapsSearchField",()=>{$field.attr("placeholder",obj.i18n.currentLocationLabel).addClass(obj.className(obj.selectors.searchFieldCurrentLocation))}),$field.off("mousedown.gkMapsSearchField").one("mousedown.gkMapsSearchField",removeContentsCallback)};$field.off("mousedown.gkMapsSearchField").one("mousedown.gkMapsSearchField",removeContentsCallback)}})},obj.getCurrentLocationOptions=()=>{return{long:parseFloat($(obj.selectors.currentLocationLng).val()),lat:parseFloat($(obj.selectors.currentLocationLat).val()),radius:parseFloat($(obj.selectors.currentLocationRadius).val()),unit:$(obj.selectors.currentLocationUnit).val(),accuracy:$(obj.selectors.currentLocationAccuracy).val(),hasSearch:Boolean(Number($(obj.selectors.currentLocationHasSearch).val()))}},obj.handleCurrentLocationError=error=>{obj.$currentLocationButton.prop("title",obj.i18n.currentLocationTitle),confirm(obj.i18n.geolocationCurrentLocationError),console.warn(`ERROR(${error.code}): `+error.message)},obj.$maps={},obj.getMap=map=>{map=map.getDiv();return $(map)},obj.shouldSearchOnMove=map=>{map=obj.getMap(map);return!!map.hasClass("gk-multi-entry-map")&&map.find(".gk-maps-search-checkbox").is(":checked")},obj.uuid=()=>{let d=(new Date).getTime();return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:3&r|8).toString(16)})},obj.includeSearchOnMoveBox=$maps=>{$maps.each((index,map)=>{const $map=$(map),data=$map.data("gkMap");if($map.hasClass("gk-multi-entry-map")){let hasBox=!1;if(data.map.controls[google.maps.ControlPosition.TOP_RIGHT].forEach(element=>{($(element).hasClass("gk-maps-element-search")||$(element).hasClass("gk-maps-element-redo-search"))&&(hasBox=!0)}),!hasBox){map=obj.uuid();const $toggleButton=$(`<label class="gk-maps-element gk-maps-element-search" for="gk-maps-search-${map}"><input type="checkbox" class="gk-maps-search-checkbox" id="gk-maps-search-${map}"> ${obj.i18n.searchOnMoveLabel}</label>`);map=obj.uuid();const $redoSearch=$(`<button class="gk-maps-element gk-maps-element-redo-search" id="gk-maps-redo-search-${map}">${obj.i18n.redoSearchLabel}</button>`);$toggleButton.on("click",()=>obj.toggleSearchOnMove(data.map)),$redoSearch.on("click",()=>{$redoSearch.prop("disabled",!0),obj.triggerSearchOnMove(data.map,()=>{data.map.controls[google.maps.ControlPosition.TOP_RIGHT].clear(),data.map.controls[google.maps.ControlPosition.TOP_RIGHT].push($toggleButton[0]),$redoSearch.prop("disabled",!1)})}),data.map.controls[google.maps.ControlPosition.TOP_RIGHT].push($toggleButton[0]),google.maps.event.addListenerOnce(data.map,"idle",()=>{google.maps.event.addListener(data.map,"bounds_changed",()=>{$map.addClass("gk-map-moved");let boundsChanged=$map.data("gkBoundsChange");!0!==(boundsChanged=void 0!==boundsChanged&&boundsChanged)&&(obj.shouldSearchOnMove(data.map)?($map.data("gkBoundsChange",!0),setTimeout(()=>{google.maps.event.addListenerOnce(data.map,"idle",()=>{$map.data("gkBoundsChange",!1),obj.triggerSearchOnMove(data.map)})},300)):(data.map.controls[google.maps.ControlPosition.TOP_RIGHT].clear(),data.map.controls[google.maps.ControlPosition.TOP_RIGHT].push($redoSearch[0])))})})}}})},obj.triggerSearchOnMove=(map,onCompleteCallback=null)=>{const $map=obj.getMap(map),mapData=$map.data("gkMap");$map.addClass("gk-multi-entry-map-avoid-rebound");var bounds=map.getBounds(),ne=bounds.getNorthEast(),bounds=bounds.getSouthWest(),mapNonce=$map.data("gkNonce"),ne={bounds:{max_lat:ne.lat(),min_lat:bounds.lat(),min_lng:ne.lng(),max_lng:bounds.lng()},filter_geolocation:1},bounds={url:obj.getRestURL(map),data:ne,headers:{},accepts:"json",dataType:"json",method:"GET",async:!0,beforeSend:(jqXHR,settings)=>obj.ajaxBeforeSend(jqXHR,settings,map),complete:(jqXHR,textStatus)=>{obj.ajaxComplete(jqXHR,textStatus,map),mapData.is_multi_entry_map||$map.removeClass("gk-multi-entry-map-avoid-rebound"),onCompleteCallback&&onCompleteCallback()},success:(data,textStatus,jqXHR)=>obj.ajaxSuccess(data,textStatus,jqXHR,map),error:(jqXHR,settings)=>obj.ajaxError(jqXHR,settings,map),context:$map};mapNonce&&(bounds.headers["X-WP-Nonce"]=mapNonce),$.ajax(bounds)},obj.ajaxBeforeSend=(jqXHR,settings,map)=>{obj.insertLoader(map);var $loader=$(document).find(".gk-maps-loader");$(document).trigger("beforeAjaxBeforeSend.Search/GravityMaps/GK",[jqXHR,settings,map]),$loader.length&&$loader.removeClass("gk-maps-loader-hidden"),$(document).trigger("afterAjaxBeforeSend.Search/GravityMaps/GK",[jqXHR,settings,map])},obj.insertLoader=map=>{},obj.ajaxComplete=(jqXHR,textStatus,map)=>{var $loader=$(document).find(".gk-maps-loader");$(document).trigger("beforeAjaxComplete.Search/GravityMaps/GK",[jqXHR,textStatus,map]),$loader.length&&$loader.addClass("gk-maps-loader-hidden"),$(document).trigger("afterAjaxComplete.Search/GravityMaps/GK",[jqXHR,textStatus,map]),obj.currentAjaxRequest=null},obj.ajaxSuccess=(html,textStatus,jqXHR,map)=>{$(document).trigger("beforeAjaxSuccess.Search/GravityMaps/GK",[html,textStatus,jqXHR,map]);var $map=obj.getMap(map),originalData=$map.data("gkMap"),$response=(originalData.radiusSearch&&originalData.radiusMarker&&(originalData.radiusSearch.setMap(null),originalData.radiusMarker.setMap(null)),$(html)),$wrapper=obj.getViewWrapper($map);let $container=obj.getResultsContainer($map);const observer=window.GV_MAPS.getObserver();let $containerReplacement;($container=0===$container.length?obj.getNoResultsContainer($wrapper):$container).find(".gv-map-canvas").each((index,map)=>observer.unobserve(map)),$response=obj.keepGeneratedMaps($wrapper,$response),obj.hasNoResults($response)?(console.log("noResults"),($containerReplacement=obj.getNoResultsContainer($response)).addClass(obj.className(obj.selectors.noResultsContainerFlag))):$containerReplacement=obj.getResponseContainer($response,originalData),$container.replaceWith($containerReplacement);$map=$response.filter('[data-js="gk-view-data"]');$map.length&&(originalData=JSON.parse($map.text()),window.GV_MAPS.MapOptions=originalData.MapOptions),window.GV_MAPS.maps=[],window.GV_MAPS.markers_info=[],window.GV_MAPS.setup_map_options(),window.GV_MAPS.initMaps($wrapper),$(document).trigger("afterAjaxSuccess.Search/GravityMaps/GK",[html,textStatus,jqXHR,map])},obj.getNoResultsContainer=$response=>$response.find(obj.selectors.noResults+", "+obj.selectors.noResultsContainerFlag),obj.hasNoResults=$response=>!!obj.getNoResultsContainer($response).length,obj.getResponseContainer=($response,originalData)=>{return $response.filter(obj.selectors.viewWrapper).find(obj.selectors.viewContainerById(originalData.view_id))},obj.getViewWrapper=$map=>{var data=$map.data("gkMap");return $map.parents(obj.selectors.viewWrapperById(data.view_id)).eq(0)},obj.getResultsContainer=$map=>{var data=$map.data("gkMap");return obj.getViewWrapper($map).find(obj.selectors.viewContainerById(data.view_id))},obj.getViewType=$container=>$container.hasClass("gv-map-container")?"map":$container.hasClass("gv-list-container")?"list":$container.hasClass("gv-table-container")?"table":"other",obj.keepGeneratedMaps=($mapsContainer,$response)=>{const $responseWrapper=$response.filter(obj.selectors.viewWrapper);return window.GV_MAPS.getMaps($mapsContainer,!0).each((index,mapEl)=>{var mapEl=$(mapEl),mapData=mapEl.data("gkMap"),canvasSelector=mapData.entry_id?".gk-map-canvas-"+mapData.entry_id:".gk-map-canvas-0, .gk-map-canvas-",canvasSelector=(mapEl.removeClass("gk-map-markers-generated"),mapData.markers.forEach(marker=>{marker.set("gkVisible",!1),marker.setVisible(!1)}),$responseWrapper.find(canvasSelector));let $container=obj.getResultsContainer(canvasSelector);0===$container.length&&($container=obj.getNoResultsContainer($responseWrapper));var viewType=obj.getViewType($container);if(!canvasSelector.length)return obj.hasNoResults($response)&&mapData.is_multi_entry_map&&(obj.getNoResultsContainer($response).before(mapEl),mapData.markers_data=[]),$response;var receivedData=canvasSelector.data("gkMap");mapData.markers_data=receivedData.markers_data,mapData.is_multi_entry_map?(mapEl.addClass("gk-multi-entry-map-avoid-rebound"),"map"===viewType&&canvasSelector.replaceWith(mapEl),window.GV_MAPS.processMapMarker(mapEl)):canvasSelector.replaceWith(mapEl)}),$response},obj.ajaxError=(jqXHR,settings,map)=>{$(document).trigger("beforeAjaxError.Search/GravityMaps/GK",[jqXHR,settings,map]),$(document).trigger("afterAjaxError.Search/GravityMaps/GK",[jqXHR,settings,map])},obj.getRestURL=map=>{map=obj.getMap(map).data("gkMap");let limit=0;return map.page_size&&(limit=map.page_size),obj.i18n.searchRestEndpoint.replace("{view_id}",map.view_id).replace("{limit}",limit)},obj.toggleSearchOnMove=map=>{var map=obj.getMap(map),shouldDisplay=!map.find(".gk-maps-element-search").find(".gk-maps-search-checkbox").is(":checked"),radiusSearch=(shouldDisplay?map.removeClass("gk-multi-entry-map-on-move"):map.addClass("gk-multi-entry-map-on-move"),map.data("gkRadiusSearch")),map=map.data("gkRadiusMarker");radiusSearch&&radiusSearch.setVisible(shouldDisplay),map&&map.setVisible(shouldDisplay)},obj.drawRadiusOnMap=($map,data,module)=>{const options=obj.getCurrentLocationOptions();!options.hasSearch||!$map.hasClass("gk-multi-entry-map")||$map.hasClass("gk-multi-entry-map-done")||0==options.lat&&0==options.long||($map.addClass("gk-multi-entry-map-done"),obj.includeSearchOnMoveBox($map),google.maps.event.addListenerOnce(data.map,"idle",()=>{$(document).trigger("beforeRadiusDraw.GravityKit/Maps",[data.map,module]),"mi"===options.unit&&(options.radius=obj.mileToKm(options.radius));const radiusSearch=new google.maps.Circle({strokeColor:"#FF0000",strokeOpacity:.6,strokeWeight:1,fillColor:"#FF0000",fillOpacity:.17,map:data.map,center:{lat:options.lat,lng:options.long},radius:1e3*options.radius});data.radiusSearch=radiusSearch;var radiusMarker=new google.maps.Marker({position:{lat:options.lat,lng:options.long},icon:{url:obj.i18n.geolocationFenceCenterImage,size:new google.maps.Size(7,7),anchor:new google.maps.Point(4,4)},map:data.map});data.radiusMarker=radiusMarker,radiusSearch.bindTo("center",radiusMarker,"position"),$map.data("gkMap",data),setTimeout(()=>{data.map.fitBounds(radiusSearch.getBounds(),10)},300),$(document).trigger("afterRadiusDraw.GravityKit/Maps",[data.map,radiusSearch,module])}))},obj.mileToKm=miles=>1.609344*miles,obj.ready=()=>{window.GV_MAPS.can_use_rest&&obj.setupCurrentLocationFieldInteractions($(obj.selectors.searchField))},$(document).on("click",obj.selectors.currentLocationButton,obj.onCurrentLocationClick),$(document).ready(obj.ready),GravityMaps.hooks.addAction("gk.maps.after_process_map_markers","gravitykit/maps",obj.drawRadiusOnMap),GravityMaps.hooks.addAction("gk.maps.after_process_map_markers","gravitykit/maps",obj.includeSearchOnMoveBox),GravityMaps.hooks.addAction("gk.maps.invalid_map_coordinates","gravitykit/maps",obj.throwInvalidCoordinatesError)})(jQuery,{},window.GravityKit.GravityMaps);